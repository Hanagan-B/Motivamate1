<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>MotivaMate - Teste Conexão</title>
</head>
<body>
  <h1>MotivaMate</h1>
  <p id="xpDisplay">XP: --</p>

  <input type="text" id="taskInput" placeholder="Digite a tarefa..." />
  <button id="btnAdd" type="button">Add Task</button>

  <ul id="taskList"></ul>
</body>

  <script>
  const API_BASE = "http://localhost:8080";
  const USER_ID = 1; // se seu usuário tiver outro id, troque aqui

  async function addTask() {
    const input = document.getElementById("taskInput");
    const title = input.value.trim();
    if (!title) return;

    try {
      const res = await fetch(`${API_BASE}/api/tasks/add`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, userId: USER_ID })
      });
      if (!res.ok) {
        const txt = await res.text();
        console.error("Falha ao adicionar:", res.status, txt);
        alert("Erro ao adicionar: " + res.status);
        return;
      }
      await loadTasks(); // recarrega lista
      input.value = "";
    } catch (e) {
      console.error("Erro de rede:", e);
      alert("Não conectou ao backend.");
    }
  }

  async function completeTask(id) {
    try {
      const res = await fetch(`${API_BASE}/api/tasks/complete/${id}`, { method: "POST" });
      if (!res.ok) {
        const txt = await res.text();
        console.warn("Falha ao completar:", res.status, txt);
      }
      await loadXP();
      await loadTasks();
    } catch (e) {
      console.error("Erro de rede:", e);
    }
  }

  async function loadTasks() {
    try {
      const res = await fetch(`${API_BASE}/api/tasks/user/${USER_ID}`);
      if (!res.ok) {
        const txt = await res.text();
        console.error("Falha ao buscar tasks:", res.status, txt);
        return;
      }
      const tasks = await res.json();
      const list = document.getElementById("taskList");
      list.innerHTML = "";

      if (!tasks || tasks.length === 0) {
        const li = document.createElement("li");
        li.textContent = "Sem tasks. Adicione uma acima.";
        list.appendChild(li);
        return;
      }

      tasks.forEach(t => {
        const li = document.createElement("li");
        li.textContent = `${t.text} ${t.completed ? "✅" : ""}`;
        if (!t.completed) {
          const btn = document.createElement("button");
          btn.textContent = "Completar";
          btn.onclick = () => completeTask(t.id);
          li.appendChild(document.createTextNode(" "));
          li.appendChild(btn);
        }
        list.appendChild(li);
      });
    } catch (e) {
      console.error("Erro de rede em loadTasks:", e);
    }
  }

  async function loadXP() {
    try {
      const res = await fetch(`${API_BASE}/api/users/${USER_ID}`);
      if (!res.ok) {
        document.getElementById("xpDisplay").textContent = "XP: (erro)";
        return;
      }
      const user = await res.json();
      document.getElementById("xpDisplay").textContent = `XP: ${user.xp ?? 0}`;
    } catch (e) {
      console.error("Erro de rede em loadXP:", e);
      document.getElementById("xpDisplay").textContent = "XP: (sem conexão)";
    }
  }

  window.onload = () => {
    loadXP();
    loadTasks();
    document.getElementById("btnAdd").onclick = addTask;
  };
</script>
</body>
</html>