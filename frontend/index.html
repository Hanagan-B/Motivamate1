<!DOCTYPE html>
<html>

<head>
  <title>MotivaMate</title>
  <script>
    async function addTask() {
      const title = document.getElementById("taskInput").value;
      const userId = 1; // default user

      await fetch("/api/tasks/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, userId })
      });

      loadTasks();
    }

    async function completeTask(id) {
      await fetch(`/api/tasks/complete/${id}`, { method: "POST" });
      loadXP();
      loadTasks();
      showBotReaction();
    }

    async function loadTasks() {
      try {
        const res = await fetch("/api/tasks/user/1");

        if (!res.ok) {
          const text = await res.text(); // will show the HTML error page
          console.error("Task fetch failed:", res.status, text);
          return;
        }

        const tasks = await res.json();

        const list = document.getElementById("taskList");
        list.innerHTML = "";
        tasks.forEach(task => {
          const li = document.createElement("li");
          li.textContent = task.text + (task.completed ? " âœ…" : "");
          if (!task.completed) {
            const btn = document.createElement("button");
            btn.textContent = "Complete";
            btn.onclick = () => completeTask(task.id);
            li.appendChild(btn);
          }
          list.appendChild(li);
        });
      } catch (err) {
        console.error("Unexpected error while loading tasks:", err);
      }
    }

    async function loadXP() {
      try {
        const res = await fetch("/api/users/1");

        if (!res.ok) {
          const text = await res.text(); // will help debug the HTML error
          console.error("XP fetch failed:", res.status, text);
          return;
        }

        const user = await res.json();
        document.getElementById("xpDisplay").textContent = "XP: " + user.xp;
      } catch (err) {
        console.error("Unexpected error while loading XP:", err);
      }
    }

    function showBotReaction() {
      const bot = document.getElementById("pixelBot");
      bot.src = "happy-bot.gif"; // your animated bot image
      setTimeout(() => bot.src = "idle-bot.gif", 3000);
    }

    window.onload = () => {
      loadTasks();
      loadXP();
    };
  </script>
</head>

<body>
  <h1>MotivaMate</h1>
  <p id="xpDisplay">XP: 0</p>
  <input type="text" id="taskInput" placeholder="Enter task..." />
  <button onclick="addTask()">Add Task</button>
  <ul id="taskList"></ul>
  <img id="pixelBot" src="idle-bot.gif" width="100" />
</body>

</html>