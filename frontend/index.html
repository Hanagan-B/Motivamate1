<!DOCTYPE html>
<html>

<head>
  <title>MotivaMate</title>
  <script>
    const API_BASE = "http://localhost:8080"; // Base URL of your Spring Boot backend

  async function addTask() {
    const title = document.getElementById("taskInput").value;
    const userId = 1; // Default user

    try {
      await fetch(`${API_BASE}/api/tasks/add`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, userId })
      });

      loadTasks();
    } catch (error) {
      console.error("Add task failed:", error);
    }
  }

  async function completeTask(id) {
    try {
      await fetch(`${API_BASE}/api/tasks/complete/${id}`, { method: "POST" });
      loadXP();
      loadTasks();
      showBotReaction();
    } catch (error) {
      console.error("Complete task failed:", error);
    }
  }

  async function loadTasks() {
    console.log("loadTasks called");
    try {
      const res = await fetch(`${API_BASE}/api/tasks/user/1`);
      if (!res.ok) {
        const errText = await res.text();
        console.error("Task fetch failed:", res.status, errText);
        return;
      }

      const tasks = await res.json();
      console.log("Tasks received:", tasks);

      const list = document.getElementById("taskList");
      list.innerHTML = "";

      tasks.forEach(task => {
        const li = document.createElement("li");
        li.textContent = task.text + (task.completed ? " âœ…" : ""); // Use 'text' instead of 'title'
        if (!task.completed) {
          const btn = document.createElement("button");
          btn.textContent = "Complete";
          btn.onclick = () => completeTask(task.id);
          li.appendChild(btn);
        }
        list.appendChild(li);
      });
    } catch (error) {
      console.error("loadTasks failed:", error);
    }
  }

  async function loadXP() {
    try {
      const res = await fetch(`${API_BASE}/api/users/1`);
      if (!res.ok) {
        const errText = await res.text();
        console.error("XP fetch failed:", res.status, errText);
        return;
      }

      const user = await res.json();
      document.getElementById("xpDisplay").textContent = "XP: " + user.xp;
    } catch (error) {
      console.error("loadXP failed:", error);
    }
  }

  function showBotReaction() {
    const bot = document.getElementById("pixelBot");
    bot.src = "happy-bot.gif"; // Ensure this file is in the same folder or adjust the path
    setTimeout(() => bot.src = "idle-bot.gif", 3000);
  }

  window.onload = () => {
    loadTasks();
    loadXP();
  };
  </script>
</head>

<body>
  <h1>MotivaMate</h1>
  <p id="xpDisplay">XP: 0</p>
  <input type="text" id="taskInput" placeholder="Enter task..." />
  <button onclick="addTask()">Add Task</button>
  <ul id="taskList"></ul>
  <img id="pixelBot" src="./src/images/idle-bot.gif" width="100" />
</body>

</html>